function ID(id){return document.getElementById(id);}
function $(qs){return document.querySelector(qs);}
function $a(qs){return document.querySelectorAll(qs);}

function switchPage(id){
    if($("page.active")){$("page.active").classList.remove("active");}
    ID(id).classList.add("active");
}
function post(url,body){
    return fetch(url,{method:'POST',body:body,headers:{'Content-Type':'application/x-www-form-urlencoded'}})
    .then((d)=>{return d.json()});
}
function getSkey(){
    bkn=0;
    nw.Window.get().cookies.get({url:"https://qun.qq.com",name:"skey"},(cookie)=>{
        let skey=cookie.value;
        for(var e=skey,t=5381,n=0,o=e.length;n<o;++n) t+=(t<<5)+e.charAt(n).charCodeAt();
        bkn=2147483647 & t;
    });
}
function webOpen(url){
    nw.Shell.openExternal(url);
}

// 页面顶栏
function doRpp(id){
    let rppElem=$(".right");
    let rppMax=rppElem.getElementsByTagName("img").length;
    if(id==rppMax){actualId=0;}else{actualId=id;}
    rppElem.getElementsByTagName("img")[0].style.marginLeft="-"+actualId*100+"%";
    setTimeout(()=>{doRpp(actualId+1);},3000);
}
doRpp(0);

// 登录页面
switchPage("login");
function submitLogin(){
    getSkey()
    switchPage("loading");
    setTimeout(()=>{
        post("https://qun.qq.com/cgi-bin/qun_mgr/get_group_list","bkn="+bkn).then((d)=>{
            if(d.create || d.join || d.manage){
                ID("groupList").innerHTML="";
                d.create.forEach(addToGroupList);
                d.join.forEach(addToGroupList);
                d.manage.forEach(addToGroupList);
                switchPage("groups");
            }else{
                alert("\n您尚未完成登录，或登录的账户没有加入任何群聊");
                switchPage("login");
            }
        });
    },500);
}
function addToGroupList(d){
    ID("groupList").innerHTML+=`
        <div data-gc="${d.gc}" onclick="selectGroup(this)">
            <img src="https://p.qlogo.cn/gh/${d.gc}/${d.gc}/40" onerror="this.src=this.src">
            <div>
                <b>${d.gn}</b>
                <span>群号：${d.gc} 丨 群主：${d.owner}</span>
            </div>
        </div>
    `;
}

// 选群页面
selectedGroups=[];
function reloadSelectedGroups(){
    Array.from($a("page#groups #groupList div")).forEach((e)=>{
        if(selectedGroups.indexOf(e.dataset.gc)!=-1){e.classList.add("active");}
        else{e.classList.remove("active");}
    });
}
function selectGroup(e){
    let gc=e.dataset.gc;
    if(selectedGroups.indexOf(gc)!=-1){selectedGroups.splice(selectedGroups.indexOf(gc),1);}
    else{selectedGroups.push(gc);}
    reloadSelectedGroups();
}
function confirmSelecedGroups(){
    if(selectedGroups.length==0){alert("\n你一个群也没撅，是要我来撅你？");}
    else{switchPage("config");}
}

// 等待页面
memberList=[];
function getMemberList(gid,mid){
    if(!selectedGroups[gid]){ initImageGenerator();getAvatar(0);}else{
        post("https://qun.qq.com/cgi-bin/qun_mgr/search_group_members",`gc=${selectedGroups[gid]}&st=${mid}&end=${mid+40}&sort=0&bkn=${bkn}`).then((d)=>{
            if(d.mems){
                d.mems.forEach((qqid)=>{
                    if(memberList.indexOf(qqid.uin)==-1){memberList.push(qqid.uin);}
                });
                ID("waitStatus").innerText="正在获取成员列表，已获取 "+memberList.length+" 位";
                getMemberList(gid,mid+40);
            }else{
                getMemberList(gid+1,0);
            }
        })
    }
}
function initImageGenerator(){
    css=`width:${ID("configImagewidth").value}px;border-radius:${ID("configShape").value}%;padding:${ID("configPadding").value/2}px`;
    ID("shots").style.width=ID("configPagewidth").value+"px";
}
function getAvatar(ids){
    ID("waitStatus").innerText="正在获取头像 ("+ids+"/"+memberList.length+")";
    qqid=memberList[ids];
    if(qqid){
        let spanElem=document.createElement("span");
        spanElem.innerHTML=`<img src="https://q4.qlogo.cn/g?b=qq&nk=${qqid}&s=640" onerror="this.src=this.src" onload="getAvatar(${ids+1})" style="${css}">`;
        ID("shots").appendChild(spanElem);
    }else{
        finishShot();
    }
}
function finishShot(){
    oldTitle=document.title;
    win=nw.Window.get();
    win.hide();
    document.title="⚠ 正在完成截图，请勿最小化或关闭页面 ⚠ - "+oldTitle;
    document.body.classList.add("finishing");
    win.show();
    win.focus();
    win.setAlwaysOnTop(true);
    setTimeout(()=>{win.captureScreenshot({fullSize:true},(e,b)=>{
        win.setAlwaysOnTop(false);
        win.hide();
        document.body.classList.remove("finishing");
        win.show();
        document.title=oldTitle;
        imageBase64="data:image/jpg;base64,"+b;
        ID("downloadLink").href=imageBase64;
        ID("downloadLink").download="群聊 "+selectedGroups.join("、")+" 的群友合影 - Generated By QQImageGenerator.jpg";
        switchPage("finish");
    })},200);
}